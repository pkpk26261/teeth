<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Idensol Chroma - æœƒå“¡ç™»å…¥</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¦·</text></svg>">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/ui-components.css">
  <style>
    /* ===== ç™»å…¥é é¢å°ˆç”¨æ¨£å¼ ===== */
    body.login-body {
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-container {
      width: 100%;
      max-width: 420px;
      transition: max-width .35s ease;
    }

    /* å“ç‰Œæ¨™è­˜ */
    .login-brand {
      text-align: center;
      margin-bottom: 36px;
    }
    .login-brand-icon {
      font-size: 48px;
      display: block;
      margin-bottom: 12px;
    }
    .login-brand-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.5px;
    }
    .login-brand-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* ç™»å…¥å¡ç‰‡ */
    .login-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 36px 32px 28px;
      box-shadow: 0 4px 24px var(--shadow-color);
    }

    /* æ¨™ç±¤é åˆ‡æ› */
    .login-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 28px;
      border-radius: 10px;
      background: var(--bg-subtle);
      padding: 4px;
    }
    .login-tab {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all .2s;
    }
    .login-tab.active {
      background: var(--card);
      color: var(--text);
      box-shadow: 0 1px 4px var(--shadow-color);
    }
    .login-tab:hover:not(.active) {
      color: var(--text);
    }

    /* è¡¨å–® */
    .login-form { display: flex; flex-direction: column; gap: 18px; }
    .login-form[hidden] { display: none; }

    .login-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .login-field label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .login-field input {
      padding: 11px 14px;
      border: 1px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .login-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    /* å¯†ç¢¼æ¬„ä½åŒ…è£¹å™¨ */
    .pw-input-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .pw-input-wrap input {
      width: 100%;
      padding-right: 42px !important;
    }
    .pw-toggle-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color .15s;
    }
    .pw-toggle-btn:hover {
      color: var(--text);
    }

    .login-submit {
      margin-top: 4px;
      padding: 12px 0;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s, transform .1s;
    }
    .login-submit:hover { opacity: 0.92; }
    .login-submit:active { transform: scale(0.98); }
    .login-submit:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ===== æ­¥é©Ÿå¼é€²åº¦åˆ— ===== */
    .reg-stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      gap: 0;
    }
    .reg-step-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reg-step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-subtle);
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .25s;
      flex-shrink: 0;
    }
    .reg-step-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      transition: color .25s;
      white-space: nowrap;
    }
    .reg-step-line {
      width: 40px;
      height: 2px;
      background: var(--border);
      margin: 0 6px;
      border-radius: 1px;
      transition: background .25s;
      flex-shrink: 0;
    }
    .reg-step-item.active .reg-step-circle {
      border-color: var(--primary);
      background: var(--primary);
      color: #fff;
    }
    .reg-step-item.active .reg-step-label { color: var(--primary); }
    .reg-step-item.done .reg-step-circle {
      border-color: var(--success);
      background: var(--success);
      color: #fff;
    }
    .reg-step-item.done .reg-step-label { color: var(--success); }
    .reg-step-line.done { background: var(--success); }
    .reg-step-line.active { background: var(--primary); }

    /* ===== æ­¥é©Ÿé¢æ¿ ===== */
    .reg-panel { display: none; flex-direction: column; gap: 18px; }
    .reg-panel.active { display: flex; }

    /* æŒ‰éˆ•åˆ— */
    .reg-btn-row {
      display: flex;
      gap: 10px;
      margin-top: 4px;
    }
    .reg-btn-row .login-submit { flex: 1; }
    .reg-btn-back {
      flex: 0 0 auto;
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
    }
    .reg-btn-back:hover { background: var(--bg-hover); }

    /* è¡¨å–®åˆ†çµ„æ¨™é¡Œ */
    .login-section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: -6px;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .login-section-title::before {
      content: '';
      display: block;
      width: 3px;
      height: 14px;
      background: var(--primary);
      border-radius: 2px;
    }

    /* æ¬„ä½è¡Œ (å…©æ¬„ä¸¦æ’) */
    .login-field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 480px) {
      .login-field-row { grid-template-columns: 1fr; }
    }

    /* ä¸‹æ‹‰é¸å–® */
    .login-field select {
      padding: 11px 14px;
      border: 1px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    .login-field select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    /* é©—è­‰ç¢¼ */
    .captcha-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .captcha-img {
      width: 140px;
      height: 44px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: #f5f5f5;
      cursor: pointer;
      flex-shrink: 0;
      object-fit: contain;
    }
    .captcha-img:hover { opacity: 0.85; }
    .captcha-refresh {
      width: 36px;
      height: 36px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--bg-subtle);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      transition: background .15s;
    }
    .captcha-refresh:hover { background: var(--bg-hover); }
    .captcha-input { flex: 1; }

    /* æç¤ºæ–‡å­— */
    .login-field .field-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: -2px;
    }

    /* å¿…å¡«æ¨™è¨˜ */
    .required-mark {
      color: var(--danger);
      margin-left: 2px;
    }

    /* å¯†ç¢¼å¼·åº¦æŒ‡ç¤ºå™¨ */
    .password-strength {
      height: 3px;
      border-radius: 2px;
      background: var(--border);
      margin-top: 2px;
      overflow: hidden;
    }
    .password-strength-bar {
      height: 100%;
      width: 0;
      border-radius: 2px;
      transition: width .3s, background .3s;
    }
    .password-strength-bar.weak { width: 25%; background: #ef4444; }
    .password-strength-bar.medium { width: 50%; background: #f59e0b; }
    .password-strength-bar.good { width: 75%; background: #22c55e; }
    .password-strength-bar.strong { width: 100%; background: #10b981; }

    .password-strength-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* å¯†ç¢¼éœ€æ±‚åˆ—è¡¨ */
    .pw-requirements {
      list-style: none;
      padding: 0;
      margin: 2px 0 0;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .pw-requirements li {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .pw-requirements li::before {
      content: 'â—‹';
      font-size: 10px;
      flex-shrink: 0;
    }
    .pw-requirements li.pass {
      color: var(--success);
    }
    .pw-requirements li.pass::before {
      content: 'âœ“';
    }

    /* éš±ç§åŒæ„ */
    .login-agree {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .login-agree input[type="checkbox"] {
      margin-top: 2px;
      accent-color: var(--primary);
    }

    /* æ“´å¤§å¡ç‰‡å¯¬åº¦ï¼ˆè¨»å†Šæ™‚ï¼‰*/
    .login-container.register-mode {
      max-width: 500px;
    }

    /* éŒ¯èª¤è¨Šæ¯ */
    .login-error {
      display: none;
      padding: 10px 14px;
      border-radius: 8px;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      color: var(--danger);
      font-size: 13px;
      text-align: center;
    }
    .login-error.show { display: block; }

    /* æˆåŠŸè¨Šæ¯ */
    .login-success {
      display: none;
      padding: 10px 14px;
      border-radius: 8px;
      background: var(--success-bg);
      color: var(--success-text);
      font-size: 13px;
      text-align: center;
    }
    .login-success.show { display: block; }

    /* åº•éƒ¨ */
    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• (å³ä¸Šè§’) */
    .login-theme-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: background .15s;
      z-index: 100;
    }
    .login-theme-toggle:hover { background: var(--bg-hover); }
    [data-theme="dark"] .login-theme-toggle .icon-sun { display: inline; }
    [data-theme="dark"] .login-theme-toggle .icon-moon { display: none; }
    .login-theme-toggle .icon-sun { display: none; }
    .login-theme-toggle .icon-moon { display: inline; }

    /* ===== å‹•ç•« ===== */
    @keyframes fadeSlideIn {
      from { opacity:0; transform: translateX(12px); }
      to   { opacity:1; transform: translateX(0); }
    }
    .reg-panel.active {
      animation: fadeSlideIn .3s ease;
    }

    /* ===== ç¶­è­·æ¨¡å¼æ©«å¹… ===== */
    .maintenance-banner {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 18px 22px;
      border-radius: 14px;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
      border: 1px solid #f0d97a;
      color: #856404;
      margin-bottom: 18px;
      animation: fadeSlideIn .4s ease;
    }
    [data-theme="dark"] .maintenance-banner {
      background: linear-gradient(135deg, #3d3517 0%, #4a3f1a 100%);
      border-color: #6d5e1e;
      color: #ffd95c;
    }
    .maintenance-icon {
      font-size: 28px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .maintenance-banner strong {
      font-size: 15px;
      display: block;
      margin-bottom: 4px;
    }
    .maintenance-banner p {
      margin: 0;
      font-size: 13px;
      line-height: 1.5;
      opacity: 0.9;
    }
  </style>
</head>
<body class="login-body">
  <!-- ä¸»é¡Œåˆ‡æ› -->
  <button class="login-theme-toggle" id="loginThemeToggle" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">
    <span class="icon-sun">â˜€ï¸</span>
    <span class="icon-moon">ğŸŒ™</span>
  </button>

  <div class="login-container">
    <!-- å“ç‰Œæ¨™è­˜ -->
    <div class="login-brand">
      <span class="login-brand-icon">ğŸ¦·</span>
      <div class="login-brand-title">Idensol Chroma</div>
      <div class="login-brand-subtitle">ç‰™ç§‘æ•¸ä½æ¯”è‰²ç³»çµ±</div>
    </div>

    <!-- ç™»å…¥å¡ç‰‡ -->
    <div class="login-card">
      <!-- ç™»å…¥ / è¨»å†Š æ¨™ç±¤åˆ‡æ› -->
      <div class="login-tabs">
        <button class="login-tab active" data-tab="login">ç™»å…¥</button>
        <button class="login-tab" data-tab="register">è¨»å†Š</button>
      </div>

      <!-- éŒ¯èª¤ / æˆåŠŸ è¨Šæ¯ -->
      <div class="login-error" id="loginError"></div>
      <div class="login-success" id="loginSuccess"></div>

      <!-- ========== ç™»å…¥è¡¨å–® ========== -->
      <form class="login-form" id="loginForm" autocomplete="on">
        <div class="login-field">
          <label for="loginUser">å¸³è™Ÿ</label>
          <input type="text" id="loginUser" name="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" autocomplete="username" required>
        </div>
        <div class="login-field">
          <label for="loginPass">å¯†ç¢¼</label>
          <div class="pw-input-wrap">
            <input type="password" id="loginPass" name="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" autocomplete="current-password" required>
            <button type="button" class="pw-toggle-btn" tabindex="-1" aria-label="é¡¯ç¤ºå¯†ç¢¼">
              <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/></svg>
            </button>
          </div>
          <div style="text-align:right;margin-top:2px;">
            <a href="/forgot-password" style="font-size:12px;color:var(--primary);text-decoration:none;font-weight:500;">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
          </div>
        </div>
        <button class="login-submit" type="submit">ç™»å…¥</button>
      </form>

      <!-- ========== æ­¥é©Ÿå¼è¨»å†Š ========== -->
      <div class="login-form" id="registerWizard" hidden>

        <!-- æ­¥é©Ÿé€²åº¦åˆ— -->
        <div class="reg-stepper">
          <div class="reg-step-item active" data-step="1">
            <div class="reg-step-circle">1</div>
            <div class="reg-step-label">å¸³è™Ÿè¨­å®š</div>
          </div>
          <div class="reg-step-line" data-line="1"></div>
          <div class="reg-step-item" data-step="2">
            <div class="reg-step-circle">2</div>
            <div class="reg-step-label">å®Œæˆè¨»å†Š</div>
          </div>
        </div>

        <!-- â–¸ æ­¥é©Ÿä¸€ï¼šå¸³è™Ÿè¨­å®š -->
        <div class="reg-panel active" id="regStep1">
          <div class="login-section-title">å¸³è™Ÿèˆ‡å¯†ç¢¼</div>
          <div class="login-field">
            <label for="regUser">å¸³è™Ÿ<span class="required-mark">*</span></label>
            <input type="text" id="regUser" name="username" placeholder="è‡³å°‘ 3 å€‹å­—å…ƒï¼ˆè‹±æ–‡/æ•¸å­—ï¼‰" autocomplete="username" required minlength="3">
          </div>
          <div class="login-field">
            <label for="regEmail">é›»å­éƒµä»¶<span class="required-mark">*</span></label>
            <input type="email" id="regEmail" name="email" placeholder="ä¾‹ï¼šdoctor@clinic.com" autocomplete="email" required>
          </div>
          <div class="login-field">
            <label for="regPass">å¯†ç¢¼<span class="required-mark">*</span></label>
            <div class="pw-input-wrap">
              <input type="password" id="regPass" name="password" placeholder="è‡³å°‘ 8 å€‹å­—å…ƒ" autocomplete="new-password" required minlength="8">
              <button type="button" class="pw-toggle-btn" tabindex="-1" aria-label="é¡¯ç¤ºå¯†ç¢¼">
                <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
            <div class="password-strength"><div class="password-strength-bar" id="pwStrengthBar"></div></div>
            <div class="password-strength-text" id="pwStrengthText"></div>
            <ul class="pw-requirements">
              <li id="pwReqLen">è‡³å°‘ 8 å€‹å­—å…ƒ</li>
              <li id="pwReqLetter">åŒ…å«è‹±æ–‡å­—æ¯</li>
              <li id="pwReqNum">åŒ…å«æ•¸å­—</li>
            </ul>
          </div>
          <div class="login-field">
            <label for="regPassConfirm">ç¢ºèªå¯†ç¢¼<span class="required-mark">*</span></label>
            <div class="pw-input-wrap">
              <input type="password" id="regPassConfirm" name="password_confirm" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" autocomplete="new-password" required>
              <button type="button" class="pw-toggle-btn" tabindex="-1" aria-label="é¡¯ç¤ºå¯†ç¢¼">
                <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/></svg>
              </button>
            </div>
          </div>
          <div class="reg-btn-row">
            <button type="button" class="login-submit" id="regNext1">ä¸‹ä¸€æ­¥</button>
          </div>
        </div>

        <!-- â–¸ æ­¥é©ŸäºŒï¼šå€‹äººè³‡è¨Š & å®Œæˆè¨»å†Š -->
        <div class="reg-panel" id="regStep2">
          <div class="login-section-title">å€‹äººè³‡è¨Š</div>
          <div class="login-field-row">
            <div class="login-field">
              <label for="regName">å§“å<span class="required-mark">*</span></label>
              <input type="text" id="regName" name="display_name" placeholder="çœŸå¯¦å§“å" required>
            </div>
            <div class="login-field">
              <label for="regPhone">è¯çµ¡é›»è©±</label>
              <input type="tel" id="regPhone" name="phone" placeholder="ä¾‹ï¼š0912-345-678" autocomplete="tel">
            </div>
          </div>

          <div class="login-section-title">å°ˆæ¥­è³‡è¨Š</div>
          <div class="login-field-row">
            <div class="login-field">
              <label for="regRole">è·æ¥­èº«ä»½<span class="required-mark">*</span></label>
              <select id="regRole" name="role" required>
                <option value="" disabled selected>è«‹é¸æ“‡</option>
                <option value="dentist">ç‰™é†«å¸«</option>
                <option value="technician">ç‰™æŠ€å¸«</option>
                <option value="assistant">ç‰™é†«åŠ©ç†</option>
                <option value="student">å­¸ç”Ÿ</option>
                <option value="other">å…¶ä»–</option>
              </select>
            </div>
            <div class="login-field">
              <label for="regLicense">è­‰æ›¸å­—è™Ÿ</label>
              <input type="text" id="regLicense" name="license_number" placeholder="é¸å¡«">
              <div class="field-hint">ç‰™é†«å¸« / ç‰™æŠ€å¸«åŸ·ç…§å­—è™Ÿ</div>
            </div>
          </div>
          <div class="login-field">
            <label for="regClinic">è¨ºæ‰€ / æŠ€å·¥æ‰€åç¨±</label>
            <input type="text" id="regClinic" name="clinic_name" placeholder="ä¾‹ï¼šå¤§å®‰ç‰™é†«è¨ºæ‰€">
          </div>

          <div class="login-section-title" style="margin-top:8px">å®‰å…¨é©—è­‰</div>
          <div class="login-field">
            <label>é©—è­‰ç¢¼<span class="required-mark">*</span></label>
            <div class="captcha-row">
              <img class="captcha-img" id="captchaImg" src="" alt="é©—è­‰ç¢¼" title="é»æ“Šé‡æ–°å–å¾—">
              <button type="button" class="captcha-refresh" id="captchaRefresh" title="é‡æ–°å–å¾—é©—è­‰ç¢¼">ğŸ”„</button>
              <input type="text" class="captcha-input" id="regCaptcha" name="captcha" placeholder="è¼¸å…¥é©—è­‰ç¢¼" required maxlength="4" autocomplete="off" style="padding:11px 14px;border:1px solid var(--input-border);border-radius:10px;background:var(--input-bg);color:var(--text);font-size:14px;outline:none;letter-spacing:4px;font-weight:700;">
            </div>
            <div class="field-hint">çœ‹ä¸æ¸…æ¥šï¼Ÿé»æ“Šåœ–ç‰‡æˆ– ğŸ”„ æŒ‰éˆ•æ›´æ›</div>
          </div>

          <label class="login-agree">
            <input type="checkbox" id="regAgree" required>
            <span>æˆ‘å·²é–±è®€ä¸¦åŒæ„<a href="#" style="color:var(--primary)">æœå‹™æ¢æ¬¾</a>åŠ<a href="#" style="color:var(--primary)">éš±ç§æ¬Šæ”¿ç­–</a></span>
          </label>

          <div class="reg-btn-row">
            <button type="button" class="reg-btn-back" id="regBack2">ä¸Šä¸€æ­¥</button>
            <button type="button" class="login-submit" id="regSubmitBtn">å»ºç«‹å¸³è™Ÿ</button>
          </div>
        </div>
      </div>

      <div class="login-footer">
        Idensol Chroma Â© 2026
      </div>
    </div>
  </div>

  <script>
  (function() {
    /* --- å¯†ç¢¼é¡¯ç¤º/éš±è—åˆ‡æ› --- */
    document.querySelectorAll('.pw-toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const wrap = btn.closest('.pw-input-wrap');
        const input = wrap.querySelector('input');
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        btn.querySelector('.eye-open').style.display = isPassword ? 'none' : '';
        btn.querySelector('.eye-closed').style.display = isPassword ? '' : 'none';
      });
    });

    /* --- ä¸»é¡Œ --- */
    const saved = localStorage.getItem('idensol-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
    document.getElementById('loginThemeToggle').addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('idensol-theme', next);
    });

    /* --- å…ƒç´  --- */
    const container = document.querySelector('.login-container');
    const tabs = document.querySelectorAll('.login-tab');
    const loginForm = document.getElementById('loginForm');
    const registerWizard = document.getElementById('registerWizard');
    const errBox = document.getElementById('loginError');
    const okBox = document.getElementById('loginSuccess');
    const registerTab = document.querySelector('.login-tab[data-tab="register"]');

    /* --- è¼‰å…¥å…¬é–‹ç³»çµ±è¨­å®š --- */
    (async function loadPublicSettings() {
      try {
        const res = await fetch('/api/public/settings');
        const data = await res.json();
        if (data.ok && data.settings) {
          const s = data.settings;
          // å‹•æ…‹å¥—ç”¨ç¶²ç«™åç¨±
          if (s.site_name) {
            document.title = s.site_name + ' - æœƒå“¡ç™»å…¥';
            const brandTitle = document.querySelector('.login-brand-title');
            if (brandTitle) brandTitle.textContent = s.site_name;
            const footer = document.querySelector('.login-footer');
            if (footer) footer.textContent = s.site_name + ' Â© ' + new Date().getFullYear();
          }
          // å‹•æ…‹å¥—ç”¨ç¶²ç«™æè¿°
          if (s.site_description) {
            const brandSub = document.querySelector('.login-brand-subtitle');
            if (brandSub) brandSub.textContent = s.site_description;
          }
          // å¦‚æœé—œé–‰è¨»å†Šï¼Œéš±è—è¨»å†Šæ¨™ç±¤
          if (s.allow_registration === '0') {
            if (registerTab) registerTab.style.display = 'none';
          }
          // ç¶­è­·æ¨¡å¼ï¼šé¡¯ç¤ºæ©«å¹…æç¤ºï¼Œéš±è—è¨»å†Š
          if (s.maintenance_mode === '1') {
            if (registerTab) registerTab.style.display = 'none';
            // æ’å…¥ç¶­è­·æ©«å¹…
            const banner = document.createElement('div');
            banner.className = 'maintenance-banner';
            banner.innerHTML = '<span class="maintenance-icon">ğŸ”§</span><div><strong>ç³»çµ±ç¶­è­·ä¸­</strong><p>ç›®å‰åƒ…é–‹æ”¾æ“æœ‰è€…å¸³è™Ÿç™»å…¥ï¼Œä¸€èˆ¬å¸³è™Ÿæš«æ™‚ç„¡æ³•ç™»å…¥èˆ‡è¨»å†Šï¼Œé€ æˆä¸ä¾¿æ•¬è«‹è¦‹è«’ã€‚</p></div>';
            const card = document.querySelector('.login-card');
            card.parentNode.insertBefore(banner, card);
          }
        }
      } catch { /* ignore */ }
    })();

    /* --- æ¨™ç±¤é åˆ‡æ› --- */
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        errBox.classList.remove('show');
        okBox.classList.remove('show');
        if (tab.dataset.tab === 'login') {
          loginForm.hidden = false;
          registerWizard.hidden = true;
          container.classList.remove('register-mode');
        } else {
          loginForm.hidden = true;
          registerWizard.hidden = false;
          container.classList.add('register-mode');
          goToStep(1);
        }
      });
    });

    function showError(msg) {
      errBox.textContent = msg;
      errBox.classList.add('show');
      okBox.classList.remove('show');
      errBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    function showSuccess(msg) {
      okBox.textContent = msg;
      okBox.classList.add('show');
      errBox.classList.remove('show');
    }
    function hideMessages() {
      errBox.classList.remove('show');
      okBox.classList.remove('show');
    }

    /* =============== æ­¥é©Ÿå¼è¨»å†Š =============== */
    let currentStep = 1;
    const totalSteps = 2;
    const panels = [null, document.getElementById('regStep1'), document.getElementById('regStep2')];
    const stepItems = registerWizard.querySelectorAll('.reg-step-item');
    const stepLines = registerWizard.querySelectorAll('.reg-step-line');

    function goToStep(n) {
      currentStep = n;
      hideMessages();
      // æ›´æ–°é¢æ¿
      panels.forEach((p, i) => { if (p) p.classList.toggle('active', i === n); });
      // æ›´æ–°é€²åº¦åˆ—
      stepItems.forEach((item) => {
        const s = parseInt(item.dataset.step);
        item.classList.remove('active', 'done');
        if (s === n) item.classList.add('active');
        else if (s < n) item.classList.add('done');
      });
      stepLines.forEach((line) => {
        const l = parseInt(line.dataset.line);
        line.classList.remove('active', 'done');
        if (l < n) line.classList.add('done');
        else if (l === n) line.classList.add('active');
      });
      // æ­¥é©ŸäºŒè¼‰å…¥é©—è­‰ç¢¼
      if (n === 2) loadCaptcha();
    }

    /* --- æ­¥é©Ÿä¸€é©—è­‰ & ä¸‹ä¸€æ­¥ --- */
    document.getElementById('regNext1').addEventListener('click', () => {
      const username = document.getElementById('regUser').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value;
      const passConfirm = document.getElementById('regPassConfirm').value;

      if (!username || username.length < 3) { showError('å¸³è™Ÿè‡³å°‘éœ€è¦ 3 å€‹å­—å…ƒ'); return; }
      if (!/^[a-zA-Z0-9_]+$/.test(username)) { showError('å¸³è™Ÿåªèƒ½åŒ…å«è‹±æ–‡ã€æ•¸å­—å’Œåº•ç·š'); return; }
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶'); return; }
      if (!pass || pass.length < 8) { showError('å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒ'); return; }
      if (!/[a-zA-Z]/.test(pass)) { showError('å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹è‹±æ–‡å­—æ¯'); return; }
      if (!/[0-9]/.test(pass)) { showError('å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹æ•¸å­—'); return; }
      if (pass !== passConfirm) { showError('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'); return; }
      goToStep(2);
    });

    /* --- å›ä¸Šä¸€æ­¥ --- */
    document.getElementById('regBack2').addEventListener('click', () => goToStep(1));

    /* --- é©—è­‰ç¢¼ (CAPTCHA) --- */
    const captchaImg = document.getElementById('captchaImg');
    const captchaRefresh = document.getElementById('captchaRefresh');

    async function loadCaptcha() {
      try {
        const res = await fetch('/api/auth/captcha');
        const data = await res.json();
        if (data.ok && data.image) captchaImg.src = data.image;
      } catch { /* éœé»˜ */ }
      const inp = document.getElementById('regCaptcha');
      if (inp) inp.value = '';
    }
    if (captchaImg) captchaImg.addEventListener('click', loadCaptcha);
    if (captchaRefresh) captchaRefresh.addEventListener('click', loadCaptcha);

    /* --- å¯†ç¢¼å¼·åº¦åµæ¸¬ --- */
    const regPass = document.getElementById('regPass');
    const pwBar = document.getElementById('pwStrengthBar');
    const pwText = document.getElementById('pwStrengthText');
    const pwReqLen = document.getElementById('pwReqLen');
    const pwReqLetter = document.getElementById('pwReqLetter');
    const pwReqNum = document.getElementById('pwReqNum');

    function checkPasswordStrength(pw) {
      let score = 0;
      const hasLen = pw.length >= 8;
      const hasLetter = /[a-zA-Z]/.test(pw);
      const hasNumber = /[0-9]/.test(pw);
      const hasUpper = /[A-Z]/.test(pw);
      const hasLower = /[a-z]/.test(pw);
      const hasSpecial = /[^a-zA-Z0-9]/.test(pw);

      // æ›´æ–°éœ€æ±‚æ¸…å–®
      pwReqLen.classList.toggle('pass', hasLen);
      pwReqLetter.classList.toggle('pass', hasLetter);
      pwReqNum.classList.toggle('pass', hasNumber);

      if (hasLen) score++;
      if (pw.length >= 12) score++;
      if (hasLetter && hasNumber) score++;
      if (hasUpper && hasLower) score++;
      if (hasSpecial) score++;

      if (score <= 1) return { text: 'å¼±', cls: 'weak' };
      if (score === 2) return { text: 'ä¸­ç­‰', cls: 'medium' };
      if (score === 3) return { text: 'è‰¯å¥½', cls: 'good' };
      return { text: 'å¼·', cls: 'strong' };
    }

    if (regPass) {
      regPass.addEventListener('input', () => {
        const val = regPass.value;
        if (!val) {
          pwBar.className = 'password-strength-bar';
          pwText.textContent = '';
          [pwReqLen, pwReqLetter, pwReqNum].forEach(el => el.classList.remove('pass'));
          return;
        }
        const r = checkPasswordStrength(val);
        pwBar.className = 'password-strength-bar ' + r.cls;
        pwText.textContent = 'å¯†ç¢¼å¼·åº¦ï¼š' + r.text;
      });
    }

    /* --- ç™»å…¥ --- */
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = loginForm.querySelector('.login-submit');
      btn.disabled = true;
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: document.getElementById('loginUser').value.trim(),
            password: document.getElementById('loginPass').value,
          }),
        });
        const data = await res.json();
        if (data.ok) {
          showSuccess('ç™»å…¥æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...');
          setTimeout(() => { window.location.href = '/'; }, 600);
        } else {
          showError(data.msg || 'ç™»å…¥å¤±æ•—');
        }
      } catch { showError('ç„¡æ³•é€£ç·šä¼ºæœå™¨'); }
      btn.disabled = false;
    });

    /* --- è¨»å†Šé€å‡º --- */
    document.getElementById('regSubmitBtn').addEventListener('click', async () => {
      const displayName = document.getElementById('regName').value.trim();
      const role = document.getElementById('regRole').value;
      const captcha = document.getElementById('regCaptcha').value.trim();
      const agree = document.getElementById('regAgree').checked;

      if (!displayName) { showError('è«‹è¼¸å…¥æ‚¨çš„å§“å'); return; }
      if (!role) { showError('è«‹é¸æ“‡æ‚¨çš„è·æ¥­èº«ä»½'); return; }
      if (!captcha) { showError('è«‹è¼¸å…¥é©—è­‰ç¢¼'); return; }
      if (!agree) { showError('è«‹åŒæ„æœå‹™æ¢æ¬¾åŠéš±ç§æ¬Šæ”¿ç­–'); return; }

      const btn = document.getElementById('regSubmitBtn');
      btn.disabled = true;
      try {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: document.getElementById('regUser').value.trim(),
            password: document.getElementById('regPass').value,
            display_name: document.getElementById('regName').value.trim(),
            email: document.getElementById('regEmail').value.trim(),
            phone: document.getElementById('regPhone').value.trim(),
            role: document.getElementById('regRole').value,
            clinic_name: document.getElementById('regClinic').value.trim(),
            license_number: document.getElementById('regLicense').value.trim(),
            captcha,
          }),
        });
        const data = await res.json();
        if (data.ok) {
          showSuccess('è¨»å†ŠæˆåŠŸï¼Œæ­£åœ¨è·³è½‰...');
          setTimeout(() => { window.location.href = '/'; }, 600);
        } else {
          showError(data.msg || 'è¨»å†Šå¤±æ•—');
          loadCaptcha();
        }
      } catch { showError('ç„¡æ³•é€£ç·šä¼ºæœå™¨'); loadCaptcha(); }
      btn.disabled = false;
    });
  })();
  </script>
</body>
</html>
