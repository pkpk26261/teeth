<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Idensol Chroma - å¿˜è¨˜å¯†ç¢¼</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¦·</text></svg>">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/ui-components.css">
  <style>
    body.login-body {
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-container {
      width: 100%;
      max-width: 420px;
    }

    .login-brand {
      text-align: center;
      margin-bottom: 36px;
    }
    .login-brand-icon { font-size: 48px; display: block; margin-bottom: 12px; }
    .login-brand-title { font-size: 28px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
    .login-brand-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 6px; }

    .login-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 36px 32px 28px;
      box-shadow: 0 4px 24px var(--shadow-color);
    }

    .card-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .card-header-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      background: var(--info-bg);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
    }
    .card-header-icon svg { color: var(--primary); }
    .card-header h2 { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
    .card-header p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

    .login-form { display: flex; flex-direction: column; gap: 18px; }

    .login-field { display: flex; flex-direction: column; gap: 6px; }
    .login-field label { font-size: 13px; font-weight: 600; color: var(--text); }
    .login-field input {
      padding: 11px 14px;
      border: 1px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .login-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    .captcha-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .captcha-img {
      width: 120px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: #f5f5f5;
      cursor: pointer;
      flex-shrink: 0;
      object-fit: contain;
    }
    .captcha-img:hover { opacity: 0.85; }
    .captcha-refresh {
      width: 34px;
      height: 34px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--bg-subtle);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      transition: background .15s;
    }
    .captcha-refresh:hover { background: var(--bg-hover); }
    .captcha-input { flex: 1; min-width: 80px; }

    .field-hint { font-size: 11px; color: var(--text-muted); margin-top: -2px; }

    .login-submit {
      margin-top: 4px;
      padding: 12px 0;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s, transform .1s;
    }
    .login-submit:hover { opacity: 0.92; }
    .login-submit:active { transform: scale(0.98); }
    .login-submit:disabled { opacity: 0.5; cursor: not-allowed; }

    .login-error {
      display: none;
      padding: 10px 14px;
      border-radius: 8px;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      color: var(--danger);
      font-size: 13px;
      text-align: center;
    }
    .login-error.show { display: block; }

    .login-success {
      display: none;
      padding: 10px 14px;
      border-radius: 8px;
      background: var(--success-bg);
      color: var(--success-text);
      font-size: 13px;
      text-align: center;
      line-height: 1.5;
    }
    .login-success.show { display: block; }

    .back-link {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 20px;
      text-align: center;
      justify-content: center;
    }
    .back-link a {
      font-size: 13px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }
    .back-link a:hover { text-decoration: underline; }

    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• */
    .login-theme-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: background .15s;
      z-index: 100;
    }
    .login-theme-toggle:hover { background: var(--bg-hover); }
    [data-theme="dark"] .login-theme-toggle .icon-sun { display: inline; }
    [data-theme="dark"] .login-theme-toggle .icon-moon { display: none; }
    .login-theme-toggle .icon-sun { display: none; }
    .login-theme-toggle .icon-moon { display: inline; }

    /* fallback å€å¡Š - SMTP å¤±æ•—æ™‚ç›´æ¥é¡¯ç¤ºé©—è­‰ç¢¼ */
    .fallback-box {
      display: none;
      padding: 16px;
      border-radius: 10px;
      background: var(--info-bg);
      border: 1px solid var(--primary);
      text-align: center;
      margin-top: 4px;
    }
    .fallback-box.show { display: block; }
    .fallback-code {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 6px;
      color: var(--primary);
      margin: 12px 0;
    }
    .fallback-box p { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
    .fallback-link {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 20px;
      background: var(--primary);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      border-radius: 8px;
      text-decoration: none;
      transition: opacity .15s;
    }
    .fallback-link:hover { opacity: 0.9; }

    @keyframes fadeSlideIn {
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }
    .login-card { animation: fadeSlideIn .35s ease; }
  </style>
</head>
<body class="login-body">
  <button class="login-theme-toggle" id="loginThemeToggle" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">
    <span class="icon-sun">â˜€ï¸</span>
    <span class="icon-moon">ğŸŒ™</span>
  </button>

  <div class="login-container">
    <div class="login-brand">
      <span class="login-brand-icon">ğŸ¦·</span>
      <div class="login-brand-title">Idensol Chroma</div>
      <div class="login-brand-subtitle">ç‰™ç§‘æ•¸ä½æ¯”è‰²ç³»çµ±</div>
    </div>

    <div class="login-card">
      <div class="card-header">
        <div class="card-header-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
        </div>
        <h2>å¿˜è¨˜å¯†ç¢¼</h2>
        <p>è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿæˆ–è¨»å†Šæ™‚çš„é›»å­éƒµä»¶ï¼Œ<br>æˆ‘å€‘å°‡ç™¼é€å¯†ç¢¼é‡è¨­é©—è­‰ä¿¡çµ¦æ‚¨ã€‚</p>
      </div>

      <div class="login-error" id="msgError"></div>
      <div class="login-success" id="msgSuccess"></div>

      <!-- éƒµä»¶å¯„é€æˆåŠŸç•«é¢ -->
      <div id="emailSentView" style="display:none;text-align:center;">
        <div style="width:56px;height:56px;border-radius:14px;background:var(--success-bg);display:inline-flex;align-items:center;justify-content:center;margin-bottom:16px;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
        </div>
        <h3 style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px;">éƒµä»¶å·²ç™¼é€ï¼</h3>
        <p id="emailSentMsg" style="font-size:13px;color:var(--text-muted);line-height:1.6;margin-bottom:20px;"></p>
        <div style="background:var(--bg-subtle);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;text-align:left;">
          <p style="font-size:13px;color:var(--text);margin-bottom:10px;font-weight:600;">  ä¸‹ä¸€æ­¥ï¼š</p>
          <ol style="font-size:12px;color:var(--text-muted);line-height:1.8;padding-left:18px;margin:0;">
            <li>é–‹å•Ÿæ‚¨çš„ä¿¡ç®±ï¼Œæ‰¾åˆ°ã€Œå¯†ç¢¼é‡è¨­é©—è­‰ã€éƒµä»¶</li>
            <li>é»æ“Šéƒµä»¶ä¸­çš„<strong>ã€Œé‡è¨­å¯†ç¢¼ã€</strong>æŒ‰éˆ•ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼</li>
            <li>è¨­å®šæ–°å¯†ç¢¼å³å¯å®Œæˆ</li>
          </ol>
        </div>
        <a href="/reset-password" style="display:inline-block;padding:12px 32px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;font-size:14px;font-weight:600;border-radius:10px;text-decoration:none;transition:opacity .15s;">æ‰‹å‹•è¼¸å…¥é©—è­‰ç¢¼</a>
        <p style="font-size:11px;color:var(--text-muted);margin-top:14px;">âœ± é©—è­‰ç¢¼æœ‰æ•ˆæœŸç‚º 30 åˆ†é˜ï¼Œè‹¥æœªæ”¶åˆ°éƒµä»¶è«‹æª¢æŸ¥åƒåœ¾éƒµä»¶è³‡æ–™å¤¾</p>
      </div>

      <!-- SMTP å¤±æ•— fallback -->
      <div class="fallback-box" id="fallbackBox">
        <p>âš ï¸ éƒµä»¶æœå‹™ç›®å‰ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹é©—è­‰ç¢¼é‡è¨­å¯†ç¢¼ï¼š</p>
        <div class="fallback-code" id="fallbackCode"></div>
        <p>è«‹åœ¨ 30 åˆ†é˜å…§å®Œæˆå¯†ç¢¼é‡è¨­ã€‚</p>
        <a href="#" class="fallback-link" id="fallbackLink">å‰å¾€é‡è¨­å¯†ç¢¼</a>
      </div>

      <form class="login-form" id="forgotForm">
        <div class="login-field">
          <label for="identifier">å¸³è™Ÿæˆ–é›»å­éƒµä»¶</label>
          <input type="text" id="identifier" name="identifier" placeholder="è«‹è¼¸å…¥å¸³è™Ÿæˆ–è¨»å†Šæ™‚çš„ Email" autocomplete="username" required>
        </div>

        <div class="login-field">
          <label>é©—è­‰ç¢¼</label>
          <div class="captcha-row">
            <img class="captcha-img" id="captchaImg" src="" alt="é©—è­‰ç¢¼" title="é»æ“Šé‡æ–°å–å¾—">
            <button type="button" class="captcha-refresh" id="captchaRefresh" title="é‡æ–°å–å¾—é©—è­‰ç¢¼">ğŸ”„</button>
            <input type="text" class="captcha-input" id="captchaInput" name="captcha" placeholder="è¼¸å…¥é©—è­‰ç¢¼" required maxlength="4" autocomplete="off" style="padding:11px 14px;border:1px solid var(--input-border);border-radius:10px;background:var(--input-bg);color:var(--text);font-size:14px;outline:none;letter-spacing:4px;font-weight:700;">
          </div>
          <div class="field-hint">çœ‹ä¸æ¸…æ¥šï¼Ÿé»æ“Šåœ–ç‰‡æˆ– ğŸ”„ æŒ‰éˆ•æ›´æ›</div>
        </div>

        <button class="login-submit" type="submit" id="submitBtn">ç™¼é€é‡è¨­ä¿¡ä»¶</button>
      </form>

      <div class="back-link">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        <a href="/login">è¿”å›ç™»å…¥</a>
      </div>
    </div>

    <div class="login-footer">
      Idensol Chroma Â© 2026
    </div>
  </div>

  <script>
  (function() {
    /* --- ä¸»é¡Œ --- */
    const saved = localStorage.getItem('idensol-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
    document.getElementById('loginThemeToggle').addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('idensol-theme', next);
    });

    /* --- è¼‰å…¥å…¬é–‹ç³»çµ±è¨­å®š --- */
    (async function loadPublicSettings() {
      try {
        const res = await fetch('/api/public/settings');
        const data = await res.json();
        if (data.ok && data.settings) {
          const s = data.settings;
          if (s.site_name) {
            document.title = s.site_name + ' - å¿˜è¨˜å¯†ç¢¼';
            const brandTitle = document.querySelector('.login-brand-title');
            if (brandTitle) brandTitle.textContent = s.site_name;
            const footer = document.querySelector('.login-footer');
            if (footer) footer.textContent = s.site_name + ' Â© ' + new Date().getFullYear();
          }
          if (s.site_description) {
            const brandSub = document.querySelector('.login-brand-subtitle');
            if (brandSub) brandSub.textContent = s.site_description;
          }
        }
      } catch { /* ignore */ }
    })();

    /* --- é©—è­‰ç¢¼ --- */
    const captchaImg = document.getElementById('captchaImg');
    async function loadCaptcha() {
      try {
        const res = await fetch('/api/auth/captcha');
        const data = await res.json();
        if (data.ok && data.image) captchaImg.src = data.image;
      } catch { /* ignore */ }
      document.getElementById('captchaInput').value = '';
    }
    captchaImg.addEventListener('click', loadCaptcha);
    document.getElementById('captchaRefresh').addEventListener('click', loadCaptcha);
    loadCaptcha();

    /* --- UI helpers --- */
    const errBox = document.getElementById('msgError');
    const okBox = document.getElementById('msgSuccess');
    const fallbackBox = document.getElementById('fallbackBox');

    function showError(msg) {
      errBox.textContent = msg;
      errBox.classList.add('show');
      okBox.classList.remove('show');
      fallbackBox.classList.remove('show');
    }
    function showSuccess(msg) {
      okBox.textContent = msg;
      okBox.classList.add('show');
      errBox.classList.remove('show');
    }

    /* --- é€å‡ºè¡¨å–® --- */
    document.getElementById('forgotForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'è™•ç†ä¸­...';

      try {
        const res = await fetch('/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            identifier: document.getElementById('identifier').value.trim(),
            captcha: document.getElementById('captchaInput').value.trim(),
          }),
        });
        const data = await res.json();

        if (!data.ok) {
          showError(data.msg || 'æ“ä½œå¤±æ•—');
          loadCaptcha();
        } else if (data.email_sent) {
          // éƒµä»¶å¯„é€æˆåŠŸâ€”â€”é¡¯ç¤ºå¼•å°ç•«é¢
          document.getElementById('forgotForm').style.display = 'none';
          document.querySelector('.card-header').style.display = 'none';
          const sentView = document.getElementById('emailSentView');
          document.getElementById('emailSentMsg').textContent = data.msg;
          sentView.style.display = 'block';
        } else if (data.fallback_token) {
          // SMTP å¤±æ•—ï¼Œé¡¯ç¤º fallback é©—è­‰ç¢¼
          showSuccess('å·²ç”¢ç”Ÿå¯†ç¢¼é‡è¨­é©—è­‰ç¢¼ã€‚');
          fallbackBox.classList.add('show');
          document.getElementById('fallbackCode').textContent = data.fallback_token;
          const link = document.getElementById('fallbackLink');
          link.href = '/reset-password?token=' + encodeURIComponent(data.fallback_url_token);
          document.getElementById('forgotForm').style.display = 'none';
        } else {
          showSuccess(data.msg);
          document.getElementById('forgotForm').style.display = 'none';
        }
      } catch {
        showError('ç„¡æ³•é€£ç·šä¼ºæœå™¨');
        loadCaptcha();
      }

      btn.disabled = false;
      btn.textContent = 'ç™¼é€é‡è¨­ä¿¡ä»¶';
    });
  })();
  </script>
</body>
</html>
