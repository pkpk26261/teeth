<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Idensol Chroma - é‡è¨­å¯†ç¢¼</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¦·</text></svg>">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/ui-components.css">
  <style>
    body.login-body {
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-container { width: 100%; max-width: 420px; }

    .login-brand { text-align: center; margin-bottom: 36px; }
    .login-brand-icon { font-size: 48px; display: block; margin-bottom: 12px; }
    .login-brand-title { font-size: 28px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
    .login-brand-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 6px; }

    .login-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 36px 32px 28px;
      box-shadow: 0 4px 24px var(--shadow-color);
    }

    .card-header { text-align: center; margin-bottom: 24px; }
    .card-header-icon {
      width: 56px; height: 56px; border-radius: 14px;
      background: var(--info-bg);
      display: inline-flex; align-items: center; justify-content: center;
      margin-bottom: 14px;
    }
    .card-header-icon svg { color: var(--primary); }
    .card-header h2 { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
    .card-header p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

    .login-form { display: flex; flex-direction: column; gap: 18px; }
    .login-form[hidden] { display: none; }

    .login-field { display: flex; flex-direction: column; gap: 6px; }
    .login-field label { font-size: 13px; font-weight: 600; color: var(--text); }
    .login-field input {
      padding: 11px 14px;
      border: 1px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .login-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    .pw-input-wrap { position: relative; display: flex; align-items: center; }
    .pw-input-wrap input { width: 100%; padding-right: 42px !important; }
    .pw-toggle-btn {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text-muted);
      padding: 2px; display: flex; align-items: center; justify-content: center;
      transition: color .15s;
    }
    .pw-toggle-btn:hover { color: var(--text); }

    .password-strength { height: 3px; border-radius: 2px; background: var(--border); margin-top: 2px; overflow: hidden; }
    .password-strength-bar { height: 100%; width: 0; border-radius: 2px; transition: width .3s, background .3s; }
    .password-strength-bar.weak { width: 25%; background: #ef4444; }
    .password-strength-bar.medium { width: 50%; background: #f59e0b; }
    .password-strength-bar.good { width: 75%; background: #22c55e; }
    .password-strength-bar.strong { width: 100%; background: #10b981; }
    .password-strength-text { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    .pw-requirements { list-style: none; padding: 0; margin: 2px 0 0; font-size: 11px; display: flex; flex-direction: column; gap: 2px; }
    .pw-requirements li { color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
    .pw-requirements li::before { content: 'â—‹'; font-size: 10px; flex-shrink: 0; }
    .pw-requirements li.pass { color: var(--success); }
    .pw-requirements li.pass::before { content: 'âœ“'; }

    .login-submit {
      margin-top: 4px; padding: 12px 0; border: none; border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff; font-size: 15px; font-weight: 600; cursor: pointer;
      transition: opacity .15s, transform .1s;
    }
    .login-submit:hover { opacity: 0.92; }
    .login-submit:active { transform: scale(0.98); }
    .login-submit:disabled { opacity: 0.5; cursor: not-allowed; }

    .login-error {
      display: none; padding: 10px 14px; border-radius: 8px;
      background: var(--danger-bg); border: 1px solid var(--danger-border);
      color: var(--danger); font-size: 13px; text-align: center;
    }
    .login-error.show { display: block; }

    .login-success {
      display: none; padding: 10px 14px; border-radius: 8px;
      background: var(--success-bg); color: var(--success-text);
      font-size: 13px; text-align: center; line-height: 1.5;
    }
    .login-success.show { display: block; }

    .back-link {
      display: flex; align-items: center; gap: 6px;
      margin-top: 20px; text-align: center; justify-content: center;
    }
    .back-link a { font-size: 13px; color: var(--primary); text-decoration: none; font-weight: 600; }
    .back-link a:hover { text-decoration: underline; }

    .login-footer { text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-muted); }

    /* æ­¥é©ŸæŒ‡ç¤º */
    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin-bottom: 24px;
    }
    .step-dot {
      width: 32px; height: 32px; border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg-subtle);
      color: var(--text-muted);
      font-size: 13px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      transition: all .25s;
    }
    .step-dot.active { border-color: var(--primary); background: var(--primary); color: #fff; }
    .step-dot.done { border-color: var(--success); background: var(--success); color: #fff; }
    .step-line {
      width: 60px; height: 2px; background: var(--border); margin: 0 8px;
      border-radius: 1px; transition: background .25s;
    }
    .step-line.active { background: var(--primary); }
    .step-line.done { background: var(--success); }

    /* é©—è­‰ç¢¼è¼¸å…¥ */
    .code-input-row {
      display: flex; gap: 8px; justify-content: center;
    }
    .code-input-row input {
      width: 44px; height: 52px;
      text-align: center;
      font-size: 20px; font-weight: 700;
      padding: 0;
      border: 2px solid var(--input-border);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .code-input-row input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    .login-theme-toggle {
      position: fixed; top: 16px; right: 16px; width: 36px; height: 36px;
      border: 1px solid var(--border); border-radius: 10px; background: var(--card);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 16px; transition: background .15s; z-index: 100;
    }
    .login-theme-toggle:hover { background: var(--bg-hover); }
    [data-theme="dark"] .login-theme-toggle .icon-sun { display: inline; }
    [data-theme="dark"] .login-theme-toggle .icon-moon { display: none; }
    .login-theme-toggle .icon-sun { display: none; }
    .login-theme-toggle .icon-moon { display: inline; }

    /* æˆåŠŸå‹•ç•« */
    .success-animation {
      display: none;
      text-align: center;
      padding: 20px 0;
    }
    .success-animation.show { display: block; }
    .success-check {
      width: 64px; height: 64px; border-radius: 50%;
      background: var(--success-bg); display: inline-flex;
      align-items: center; justify-content: center;
      margin-bottom: 16px;
      animation: successPop .4s ease;
    }
    .success-check svg { color: var(--success); }
    .success-animation h3 { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .success-animation p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
    .success-animation .login-submit { margin-top: 16px; display: inline-block; padding: 12px 32px; }

    @keyframes successPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeSlideIn {
      from { opacity:0; transform: translateY(8px); }
      to   { opacity:1; transform: translateY(0); }
    }
    .login-card { animation: fadeSlideIn .35s ease; }
  </style>
</head>
<body class="login-body">
  <button class="login-theme-toggle" id="loginThemeToggle" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">
    <span class="icon-sun">â˜€ï¸</span>
    <span class="icon-moon">ğŸŒ™</span>
  </button>

  <div class="login-container">
    <div class="login-brand">
      <span class="login-brand-icon">ğŸ¦·</span>
      <div class="login-brand-title">Idensol Chroma</div>
      <div class="login-brand-subtitle">ç‰™ç§‘æ•¸ä½æ¯”è‰²ç³»çµ±</div>
    </div>

    <div class="login-card">
      <!-- æ­¥é©ŸæŒ‡ç¤º -->
      <div class="step-indicator">
        <div class="step-dot active" id="stepDot1">1</div>
        <div class="step-line" id="stepLine1"></div>
        <div class="step-dot" id="stepDot2">2</div>
      </div>

      <div class="login-error" id="msgError"></div>
      <div class="login-success" id="msgSuccess"></div>

      <!-- ===== æ­¥é©Ÿä¸€ï¼šé©—è­‰èº«ä»½ ===== -->
      <div class="login-form" id="step1Form">
        <div class="card-header" style="margin-bottom:8px">
          <h2>é©—è­‰èº«ä»½</h2>
          <p>è«‹è¼¸å…¥æ‚¨æ”¶åˆ°çš„ 6 ä½æ•¸é©—è­‰ç¢¼ã€‚<br>å¦‚æœæ‚¨æ˜¯é€éé€£çµåˆ°é”æ­¤é ï¼Œç³»çµ±æœƒè‡ªå‹•é©—è­‰ã€‚</p>
        </div>

        <div class="login-field" style="align-items:center">
          <label style="text-align:center">é©—è­‰ç¢¼</label>
          <div class="code-input-row" id="codeInputRow">
            <input type="text" maxlength="1" data-idx="0" inputmode="numeric" autocomplete="off">
            <input type="text" maxlength="1" data-idx="1" inputmode="numeric" autocomplete="off">
            <input type="text" maxlength="1" data-idx="2" inputmode="numeric" autocomplete="off">
            <input type="text" maxlength="1" data-idx="3" inputmode="numeric" autocomplete="off">
            <input type="text" maxlength="1" data-idx="4" inputmode="numeric" autocomplete="off">
            <input type="text" maxlength="1" data-idx="5" inputmode="numeric" autocomplete="off">
          </div>
        </div>

        <button class="login-submit" type="button" id="verifyBtn">é©—è­‰</button>
      </div>

      <!-- ===== æ­¥é©ŸäºŒï¼šè¨­å®šæ–°å¯†ç¢¼ ===== -->
      <div class="login-form" id="step2Form" hidden>
        <div class="card-header" style="margin-bottom:8px">
          <h2>è¨­å®šæ–°å¯†ç¢¼</h2>
          <p>è«‹è¼¸å…¥æ‚¨çš„æ–°å¯†ç¢¼ã€‚</p>
        </div>

        <div class="login-field">
          <label for="newPassword">æ–°å¯†ç¢¼</label>
          <div class="pw-input-wrap">
            <input type="password" id="newPassword" placeholder="è‡³å°‘ 8 å€‹å­—å…ƒ" autocomplete="new-password" required minlength="8">
            <button type="button" class="pw-toggle-btn" tabindex="-1" aria-label="é¡¯ç¤ºå¯†ç¢¼">
              <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/></svg>
            </button>
          </div>
          <div class="password-strength"><div class="password-strength-bar" id="pwStrengthBar"></div></div>
          <div class="password-strength-text" id="pwStrengthText"></div>
          <ul class="pw-requirements">
            <li id="pwReqLen">è‡³å°‘ 8 å€‹å­—å…ƒ</li>
            <li id="pwReqLetter">åŒ…å«è‹±æ–‡å­—æ¯</li>
            <li id="pwReqNum">åŒ…å«æ•¸å­—</li>
          </ul>
        </div>

        <div class="login-field">
          <label for="confirmPassword">ç¢ºèªæ–°å¯†ç¢¼</label>
          <div class="pw-input-wrap">
            <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" autocomplete="new-password" required>
            <button type="button" class="pw-toggle-btn" tabindex="-1" aria-label="é¡¯ç¤ºå¯†ç¢¼">
              <svg class="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg class="eye-closed" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/></svg>
            </button>
          </div>
        </div>

        <button class="login-submit" type="button" id="resetBtn">é‡è¨­å¯†ç¢¼</button>
      </div>

      <!-- ===== å®Œæˆç•«é¢ ===== -->
      <div class="success-animation" id="successView">
        <div class="success-check">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <h3>å¯†ç¢¼é‡è¨­æˆåŠŸï¼</h3>
        <p>æ‚¨çš„å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ã€‚<br>è«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥å¸³è™Ÿã€‚</p>
        <button class="login-submit" onclick="window.location.href='/login'">å‰å¾€ç™»å…¥</button>
      </div>

      <div class="back-link">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        <a href="/login">è¿”å›ç™»å…¥</a>
      </div>
    </div>

    <div class="login-footer">
      Idensol Chroma Â© 2026
    </div>
  </div>

  <script>
  (function() {
    /* --- ä¸»é¡Œ --- */
    const saved = localStorage.getItem('idensol-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
    document.getElementById('loginThemeToggle').addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('idensol-theme', next);
    });

    /* --- è¼‰å…¥å…¬é–‹ç³»çµ±è¨­å®š --- */
    (async function loadPublicSettings() {
      try {
        const res = await fetch('/api/public/settings');
        const data = await res.json();
        if (data.ok && data.settings) {
          const s = data.settings;
          if (s.site_name) {
            document.title = s.site_name + ' - é‡è¨­å¯†ç¢¼';
            const brandTitle = document.querySelector('.login-brand-title');
            if (brandTitle) brandTitle.textContent = s.site_name;
            const footer = document.querySelector('.login-footer');
            if (footer) footer.textContent = s.site_name + ' Â© ' + new Date().getFullYear();
          }
          if (s.site_description) {
            const brandSub = document.querySelector('.login-brand-subtitle');
            if (brandSub) brandSub.textContent = s.site_description;
          }
        }
      } catch { /* ignore */ }
    })();

    /* --- å¯†ç¢¼é¡¯ç¤º/éš±è—åˆ‡æ› --- */
    document.querySelectorAll('.pw-toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const wrap = btn.closest('.pw-input-wrap');
        const input = wrap.querySelector('input');
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        btn.querySelector('.eye-open').style.display = isPassword ? 'none' : '';
        btn.querySelector('.eye-closed').style.display = isPassword ? '' : 'none';
      });
    });

    /* --- UI helpers --- */
    const errBox = document.getElementById('msgError');
    const okBox = document.getElementById('msgSuccess');
    function showError(msg) { errBox.textContent = msg; errBox.classList.add('show'); okBox.classList.remove('show'); }
    function showSuccess(msg) { okBox.textContent = msg; okBox.classList.add('show'); errBox.classList.remove('show'); }
    function hideMessages() { errBox.classList.remove('show'); okBox.classList.remove('show'); }

    /* --- ç‹€æ…‹ --- */
    let urlToken = '';
    let verifiedCode = '';

    // å¾ URL å–å¾— token
    const params = new URLSearchParams(window.location.search);
    const tokenFromUrl = params.get('token') || '';

    /* --- é©—è­‰ç¢¼è¼¸å…¥æ¡†è‡ªå‹•è·³è½‰ --- */
    const codeInputs = document.querySelectorAll('#codeInputRow input');
    codeInputs.forEach((inp, i) => {
      inp.addEventListener('input', (e) => {
        const val = e.target.value;
        if (val && i < codeInputs.length - 1) {
          codeInputs[i + 1].focus();
        }
        // è‡ªå‹•é€å‡º
        if (i === codeInputs.length - 1 && val) {
          const code = Array.from(codeInputs).map(x => x.value).join('');
          if (code.length === 6) document.getElementById('verifyBtn').click();
        }
      });
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !inp.value && i > 0) {
          codeInputs[i - 1].focus();
        }
      });
      // æ”¯æ´è²¼ä¸Š
      inp.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text').trim();
        for (let j = 0; j < text.length && j < codeInputs.length; j++) {
          codeInputs[j].value = text[j];
        }
        if (text.length >= codeInputs.length) {
          codeInputs[codeInputs.length - 1].focus();
          setTimeout(() => document.getElementById('verifyBtn').click(), 100);
        } else if (text.length > 0) {
          codeInputs[Math.min(text.length, codeInputs.length - 1)].focus();
        }
      });
    });

    /* --- å¦‚æœ URL æœ‰ tokenï¼Œè‡ªå‹•é©—è­‰ä¸¦è·³åˆ°æ­¥é©ŸäºŒ --- */
    if (tokenFromUrl) {
      (async function autoVerify() {
        try {
          const res = await fetch('/api/auth/verify-reset-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: tokenFromUrl }),
          });
          const data = await res.json();
          if (data.ok) {
            urlToken = data.url_token || tokenFromUrl;
            goToStep2();
          } else {
            showError(data.msg || 'é€£çµç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹é‡æ–°ç”³è«‹ã€‚');
          }
        } catch {
          showError('ç„¡æ³•é€£ç·šä¼ºæœå™¨');
        }
      })();
    } else {
      codeInputs[0].focus();
    }

    /* --- æ­¥é©Ÿåˆ‡æ› --- */
    function goToStep2() {
      document.getElementById('step1Form').hidden = true;
      document.getElementById('step2Form').hidden = false;
      document.getElementById('stepDot1').classList.remove('active');
      document.getElementById('stepDot1').classList.add('done');
      document.getElementById('stepDot1').textContent = 'âœ“';
      document.getElementById('stepLine1').classList.add('done');
      document.getElementById('stepDot2').classList.add('active');
      hideMessages();
      document.getElementById('newPassword').focus();
    }

    function goToSuccess() {
      document.getElementById('step2Form').hidden = true;
      document.getElementById('stepDot2').classList.remove('active');
      document.getElementById('stepDot2').classList.add('done');
      document.getElementById('stepDot2').textContent = 'âœ“';
      document.getElementById('stepLine1').classList.add('done');
      document.querySelector('.step-indicator').style.display = 'none';
      document.getElementById('successView').classList.add('show');
      hideMessages();
    }

    /* --- æ­¥é©Ÿä¸€ï¼šé©—è­‰ç¢¼é©—è­‰ --- */
    document.getElementById('verifyBtn').addEventListener('click', async () => {
      const code = Array.from(codeInputs).map(x => x.value).join('');
      if (code.length !== 6) { showError('è«‹è¼¸å…¥å®Œæ•´çš„ 6 ä½æ•¸é©—è­‰ç¢¼'); return; }

      const btn = document.getElementById('verifyBtn');
      btn.disabled = true;
      btn.textContent = 'é©—è­‰ä¸­...';

      try {
        const res = await fetch('/api/auth/verify-reset-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code }),
        });
        const data = await res.json();
        if (data.ok) {
          urlToken = data.url_token || '';
          verifiedCode = code;
          goToStep2();
        } else {
          showError(data.msg || 'é©—è­‰ç¢¼ç„¡æ•ˆ');
        }
      } catch {
        showError('ç„¡æ³•é€£ç·šä¼ºæœå™¨');
      }

      btn.disabled = false;
      btn.textContent = 'é©—è­‰';
    });

    /* --- å¯†ç¢¼å¼·åº¦åµæ¸¬ --- */
    const pwInput = document.getElementById('newPassword');
    const pwBar = document.getElementById('pwStrengthBar');
    const pwText = document.getElementById('pwStrengthText');
    const pwReqLen = document.getElementById('pwReqLen');
    const pwReqLetter = document.getElementById('pwReqLetter');
    const pwReqNum = document.getElementById('pwReqNum');

    function checkPasswordStrength(pw) {
      let score = 0;
      const hasLen = pw.length >= 8;
      const hasLetter = /[a-zA-Z]/.test(pw);
      const hasNumber = /[0-9]/.test(pw);
      const hasUpper = /[A-Z]/.test(pw);
      const hasLower = /[a-z]/.test(pw);
      const hasSpecial = /[^a-zA-Z0-9]/.test(pw);

      pwReqLen.classList.toggle('pass', hasLen);
      pwReqLetter.classList.toggle('pass', hasLetter);
      pwReqNum.classList.toggle('pass', hasNumber);

      if (hasLen) score++;
      if (pw.length >= 12) score++;
      if (hasLetter && hasNumber) score++;
      if (hasUpper && hasLower) score++;
      if (hasSpecial) score++;

      if (score <= 1) return { text: 'å¼±', cls: 'weak' };
      if (score === 2) return { text: 'ä¸­ç­‰', cls: 'medium' };
      if (score === 3) return { text: 'è‰¯å¥½', cls: 'good' };
      return { text: 'å¼·', cls: 'strong' };
    }

    pwInput.addEventListener('input', () => {
      const val = pwInput.value;
      if (!val) {
        pwBar.className = 'password-strength-bar';
        pwText.textContent = '';
        [pwReqLen, pwReqLetter, pwReqNum].forEach(el => el.classList.remove('pass'));
        return;
      }
      const r = checkPasswordStrength(val);
      pwBar.className = 'password-strength-bar ' + r.cls;
      pwText.textContent = 'å¯†ç¢¼å¼·åº¦ï¼š' + r.text;
    });

    /* --- æ­¥é©ŸäºŒï¼šé‡è¨­å¯†ç¢¼ --- */
    document.getElementById('resetBtn').addEventListener('click', async () => {
      const newPw = document.getElementById('newPassword').value;
      const confirmPw = document.getElementById('confirmPassword').value;

      if (!newPw || newPw.length < 8) { showError('æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒ'); return; }
      if (!/[a-zA-Z]/.test(newPw)) { showError('æ–°å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹è‹±æ–‡å­—æ¯'); return; }
      if (!/[0-9]/.test(newPw)) { showError('æ–°å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹æ•¸å­—'); return; }
      if (newPw !== confirmPw) { showError('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'); return; }

      const btn = document.getElementById('resetBtn');
      btn.disabled = true;
      btn.textContent = 'é‡è¨­ä¸­...';

      try {
        const body = { new_password: newPw };
        if (urlToken) body.token = urlToken;
        if (verifiedCode) body.code = verifiedCode;

        const res = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (data.ok) {
          goToSuccess();
        } else {
          showError(data.msg || 'é‡è¨­å¤±æ•—');
        }
      } catch {
        showError('ç„¡æ³•é€£ç·šä¼ºæœå™¨');
      }

      btn.disabled = false;
      btn.textContent = 'é‡è¨­å¯†ç¢¼';
    });
  })();
  </script>
</body>
</html>
